<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Push Notifications - Standalone</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .content { padding: 30px; }
    
    button { 
      padding: 12px 20px; 
      margin: 8px; 
      background: linear-gradient(135deg, #4285f4, #34a853);
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }
    
    #log { 
      background: #f8f9fa; 
      padding: 20px; 
      border-radius: 10px; 
      max-height: 400px; 
      overflow-y: auto; 
      font-family: 'Courier New', monospace; 
      font-size: 13px;
      border: 2px solid #e9ecef;
      white-space: pre-wrap;
    }
    
    .status { 
      padding: 15px; 
      margin: 15px 0; 
      border-radius: 10px; 
      font-weight: bold;
      text-align: center;
      font-size: 16px;
    }
    .status.granted { 
      background: linear-gradient(135deg, #d4edda, #c3e6cb); 
      color: #155724; 
      border: 2px solid #28a745; 
    }
    .status.denied { 
      background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
      color: #721c24; 
      border: 2px solid #dc3545; 
    }
    .status.default { 
      background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
      color: #856404; 
      border: 2px solid #ffc107; 
    }
    
    .config-section {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 2px solid #2196f3;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }
    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .instructions {
      background: #f8f9fa;
      border-left: 4px solid #4285f4;
      padding: 15px;
      margin: 20px 0;
    }
    
    @media (max-width: 768px) {
      .content { padding: 20px; }
      .button-group { flex-direction: column; }
      button { width: 100%; margin: 5px 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîî Firebase Push Notifications</h1>
      <p>Standalone Version - Host on Your Own Domain</p>
    </div>
    
    <div class="content">
      <div class="alert warning">
        <strong>‚ö†Ô∏è Important:</strong> This page should be hosted on your own domain (not googleusercontent.com) for notifications to work properly. 
        Save this HTML file and upload it to GitHub Pages, Netlify, Vercel, or your web server.
      </div>
      
      <div class="config-section">
        <h3>‚öôÔ∏è Configuration</h3>
        <label><strong>Apps Script Web App URL:</strong></label>
        <input type="text" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
        <small>Get this URL from your Google Apps Script deployment (Deploy ‚Üí New Deployment ‚Üí Web App)</small>
      </div>
      
      <div id="statusDisplay" class="status default">
        Permission Status: <span id="permissionStatus">Checking...</span>
      </div>
      
      <div class="button-group">
        <button id="checkStatusBtn">üîç Check Status</button>
        <button id="requestPermBtn">‚úã Request Permission</button>
        <button id="registerTokenBtn" disabled>üìù Register Token</button>
        <button id="testNotificationBtn" disabled>üß™ Test Notification</button>
        <button id="forcePermissionBtn">üîì Force Permission Override</button>
      </div>

      <div class="instructions">
        <h4>üõ†Ô∏è Manual Browser Fix for googleusercontent.com:</h4>
        <ol>
          <li><strong>Chrome/Opera:</strong> Copy this URL: <code id="currentUrl"></code></li>
          <li>Go to <code>chrome://settings/content/notifications</code> (or <code>opera://settings/content/notifications</code>)</li>
          <li>Click "Add" next to "Allow to send notifications"</li>
          <li>Paste the URL and click "Add"</li>
          <li>Refresh this page and try again</li>
        </ol>
        <p><strong>Alternative:</strong> Click the lock/info icon in the address bar ‚Üí Site Settings ‚Üí Notifications ‚Üí Allow</p>
      </div>

      <div style="margin: 30px 0;">
        <h3>üìã Debug Log:</h3>
        <div class="button-group">
          <button id="clearLogBtn" style="background: #dc3545;">Clear Log</button>
          <button id="copyLogBtn" style="background: #6c757d;">Copy Log</button>
        </div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-messaging.js";

    // DOM Elements
    const logBox = document.getElementById('log');
    const permissionStatusEl = document.getElementById('permissionStatus');
    const statusDisplayEl = document.getElementById('statusDisplay');
    const registerBtn = document.getElementById('registerTokenBtn');
    const testBtn = document.getElementById('testNotificationBtn');
    const appsScriptUrlInput = document.getElementById('appsScriptUrl');
    const currentUrlEl = document.getElementById('currentUrl');

    // Set current URL for manual fix instructions
    currentUrlEl.textContent = window.location.origin + window.location.pathname;

    const log = (msg, type = 'info') => {
      const timestamp = new Date().toLocaleTimeString();
      const logMsg = `[${timestamp}] ${msg}`;
      console.log(logMsg);
      
      const logEntry = document.createElement('div');
      logEntry.textContent = logMsg;
      logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#333';
      logBox.appendChild(logEntry);
      logBox.scrollTop = logBox.scrollHeight;
    };

    const updatePermissionStatus = () => {
      const permission = Notification.permission;
      permissionStatusEl.textContent = permission.toUpperCase();
      
      statusDisplayEl.className = `status ${permission}`;
      
      if (permission === 'granted') {
        registerBtn.disabled = false;
        testBtn.disabled = false;
      } else {
        registerBtn.disabled = true;
        testBtn.disabled = true;
      }
      
      log(`Permission status: ${permission}`, permission === 'granted' ? 'success' : permission === 'denied' ? 'error' : 'warning');
    };

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCRKhcp_SHx3JhK9voZdLUEYjgDsd8UFS8",
      authDomain: "electro-12753.firebaseapp.com",
      projectId: "electro-12753",
      storageBucket: "electro-12753.firebasestorage.app",
      messagingSenderId: "34147042347",
      appId: "1:34147042347:web:e358bb7763a6afff03566e",
      measurementId: "G-MXBD5C0ZDJ"
    };

    const vapidKey = "BJymDhXcSBI5afnuuDumd_CTyg15QDL7dXRQn9Zrilb3INFV5db4IriJSvDL9ki77qJGz__Twq3p5Kzkmb3Pu4w";

    // Initialize Firebase
    let app, messaging;
    try {
      app = initializeApp(firebaseConfig);
      messaging = getMessaging(app);
      log('‚úÖ Firebase initialized successfully', 'success');
    } catch (e) {
      log(`‚ùå Firebase initialization error: ${e.message}`, 'error');
    }

    // Check initial status
    updatePermissionStatus();

    // Event Listeners
    document.getElementById('checkStatusBtn').addEventListener('click', () => {
      updatePermissionStatus();
      
      const domain = window.location.hostname;
      log(`üåê Current domain: ${domain}`);
      log(`üîí Secure context: ${window.isSecureContext}`);
      log(`üîß Service Worker support: ${('serviceWorker' in navigator)}`);
      log(`üåç User Agent: ${navigator.userAgent}`);
      
      if (domain.includes('googleusercontent.com')) {
        log('‚ö†Ô∏è  WARNING: googleusercontent.com domain detected!', 'warning');
        log('üí° This domain is commonly blocked by browsers', 'warning');
        log('üöÄ Solution: Host on your own domain or enable manually', 'warning');
      } else {
        log('‚úÖ Good! Not on googleusercontent.com domain', 'success');
      }
    });

    document.getElementById('requestPermBtn').addEventListener('click', async () => {
      try {
        log('üîÑ Requesting notification permission...');
        
        if (!window.isSecureContext) {
          log('‚ùå Not in secure context (HTTPS required)', 'error');
          alert('‚ùå Notifications require HTTPS');
          return;
        }

        if (!('Notification' in window)) {
          log('‚ùå Notifications not supported in this browser', 'error');
          alert('‚ùå Push notifications are not supported in this browser');
          return;
        }

        const domain = window.location.hostname;
        if (domain.includes('googleusercontent.com')) {
          log('‚ö†Ô∏è  Attempting permission on restricted domain', 'warning');
        }

        const result = await Notification.requestPermission();
        log(`üìã Permission result: ${result}`, result === 'granted' ? 'success' : 'error');
        
        updatePermissionStatus();
        
        if (result === 'granted') {
          alert('‚úÖ Notification permission granted!');
          log('üéâ Success! You can now register for push notifications', 'success');
        } else if (result === 'denied') {
          log('‚ùå Permission denied by browser', 'error');
          alert('‚ùå Permission denied. Please enable manually:\n\n1. Click lock icon in address bar\n2. Set Notifications to "Allow"\n3. Refresh page\n\nOr host this page on your own domain.');
        } else {
          log('‚ö†Ô∏è  Permission request dismissed', 'warning');
          alert('‚ö†Ô∏è Permission request was dismissed');
        }
        
      } catch (e) {
        log(`‚ùå Exception requesting permission: ${e.message}`, 'error');
        alert(`‚ùå Error: ${e.message}`);
      }
    });

    document.getElementById('forcePermissionBtn').addEventListener('click', () => {
      const instructions = `
üîì FORCE PERMISSION OVERRIDE INSTRUCTIONS:

For Chrome/Opera:
1. Copy this URL: ${window.location.origin}
2. Open: chrome://settings/content/notifications
3. Click "Add" next to "Allow to send notifications"
4. Paste the URL and click "Add"
5. Refresh this page

For Firefox:
1. Click the shield icon in address bar
2. Turn off "Enhanced Tracking Protection"
3. Click the lock icon ‚Üí Connection secure ‚Üí More information
4. Permissions tab ‚Üí Notifications ‚Üí Allow

Alternative method:
1. Click the lock/info icon in address bar
2. Click "Site settings" or "Permissions"
3. Change Notifications from "Block" to "Allow"
4. Refresh the page

Then come back and click "Request Permission" again.
      `;
      
      alert(instructions);
      log('üìã Force permission instructions displayed', 'warning');
    });

    document.getElementById('registerTokenBtn').addEventListener('click', async () => {
      if (Notification.permission !== 'granted') {
        alert('‚ùå Notification permission not granted');
        return;
      }

      const appsScriptUrl = appsScriptUrlInput.value.trim();
      if (!appsScriptUrl) {
        alert('‚ùå Please enter your Apps Script web app URL');
        appsScriptUrlInput.focus();
        return;
      }

      try {
        log('üîÑ Getting FCM token...');
        
        const token = await getToken(messaging, { vapidKey });
        if (!token) {
          log('‚ùå Failed to get FCM token', 'error');
          alert('‚ùå Failed to get token. Check console for details.');
          return;
        }
        
        log(`‚úÖ FCM Token received: ${token.substring(0, 30)}...`, 'success');

        // Store token via Apps Script
        log('üì§ Sending token to Apps Script...');
        
        const response = await fetch(appsScriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `action=storeToken&token=${encodeURIComponent(token)}`,
          mode: 'cors'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.text();
        log(`‚úÖ Apps Script response: ${result}`, 'success');
        alert(`‚úÖ Success: ${result}`);

      } catch (err) {
        log(`‚ùå Error: ${err.message}`, 'error');
        alert(`‚ùå Error: ${err.message}`);
      }
    });

    document.getElementById('testNotificationBtn').addEventListener('click', () => {
      if (Notification.permission !== 'granted') {
        alert('‚ùå Notifications not permitted');
        return;
      }

      log('üß™ Creating test notification...');
      
      const notification = new Notification('üéâ Test Successful!', {
        body: 'Your notification system is working correctly!',
        icon: 'https://firebase.google.com/images/brand-guidelines/logo-standard.png',
        badge: 'https://firebase.google.com/images/brand-guidelines/logo-standard.png',
        tag: 'test-notification',
        requireInteraction: false
      });
      
      notification.onclick = () => {
        log('üì± Test notification clicked', 'success');
        window.focus();
        notification.close();
      };
      
      notification.onshow = () => {
        log('‚úÖ Test notification displayed', 'success');
      };
      
      notification.onerror = (e) => {
        log(`‚ùå Notification error: ${e}`, 'error');
      };
      
      setTimeout(() => {
        notification.close();
        log('‚è∞ Test notification auto-closed', 'info');
      }, 5000);
    });

    document.getElementById('clearLogBtn').addEventListener('click', () => {
      logBox.innerHTML = '';
      log('üóëÔ∏è Log cleared');
    });

    document.getElementById('copyLogBtn').addEventListener('click', () => {
      const logText = logBox.textContent;
      navigator.clipboard.writeText(logText).then(() => {
        alert('üìã Log copied to clipboard!');
      }).catch(() => {
        alert('‚ùå Failed to copy log');
      });
    });

    // Handle incoming FCM messages
    if (messaging) {
      onMessage(messaging, (payload) => {
        log(`üì® FCM Message received: ${JSON.stringify(payload)}`, 'success');
        
        if (payload.notification && Notification.permission === 'granted') {
          const { title, body } = payload.notification;
          
          const notif = new Notification(title, {
            body: body,
            icon: payload.notification.icon || 'https://firebase.google.com/images/brand-guidelines/logo-standard.png',
            data: payload.data
          });
          
          notif.onclick = () => {
            log('üì± FCM notification clicked', 'success');
            window.focus();
            notif.close();
          };
        }
      });
    }

    // Initial setup
    log('üöÄ Application loaded and ready');
    
    if (window.location.hostname.includes('googleusercontent.com')) {
      log('‚ö†Ô∏è  Running on restricted googleusercontent.com domain', 'warning');
      log('üí° For better compatibility, save this HTML file and host it on your own domain', 'warning');
    } else {
      log('‚úÖ Running on compatible domain', 'success');
    }

    // Auto-populate Apps Script URL if we're on the domain
    if (window.location.hostname.includes('googleusercontent.com')) {
      // Try to extract the script ID from the URL
      const urlParts = window.location.pathname.split('/');
      if (urlParts.length > 1) {
        const scriptId = urlParts[1];
        appsScriptUrlInput.value = `https://script.google.com/macros/s/${scriptId}/exec`;
        log('üìù Auto-detected Apps Script URL', 'info');
      }
    }
  </script>
</body>
</html>
